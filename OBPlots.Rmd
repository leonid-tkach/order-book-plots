---
title: "OBPlots"
output: html_notebook
---

```{r}
library(tidyverse)
```


```{r}
obp_dynatts_df <- read_csv("resources/3_obp_dynatts_df.csv")
obp_dynatts_df
```

```{r}
OBPlots_df <- read_csv("resources/2_OBPlots_df.csv")
OBPlots_df
```

```{r}
obp_dynatts_no_df <- left_join(obp_dynatts_df, 
                            OBPlots_df %>% select(NO, TIME), 
                            by = "NO") %>% 
  mutate(TIMEm = as.character(as.integer(TIME / 100000)),
         TIME = as.character(TIME / 1000)) %>% 
  select(NO, SECCODE, DATETIMEMLLS, DATE, TIME, TIMEm, OBPLOTNO, 
         ATT, VAL, SHAREBAL, BPROFIT, SPROFIT, OBPMINTPRICE, OBPMAXTPRICE,
         CBOVOLtdcs, CSOVOLtdcs, BOVOLtdcs, SOVOLtdcs, BTVOLtdcs, STVOLtdcs,
         CBOVOLobpcs, CSOVOLobpcs, BOVOLobpcs, SOVOLobpcs, BTVOLobpcs, STVOLobpcs)
obp_dynatts_no_df
```

```{r}
obp_dynatts_no_price_df <- left_join(obp_dynatts_no_df, 
                                     OBPlots_df %>% select(NO, PRICE, TRADEPRICE), 
                                     by="NO")
obp_dynatts_no_price_df
```

```{r}
temp_df <- obp_dynatts_no_df %>% 
  spread(key = ATT, value = VAL) %>% 
  select(TIME, TIMEm, NO, OBPLOTNO, SOVOL, SOVOLtdcs, SOVOLobpcs)
  # filter(OBPLOTNO == 129)
temp_df
```

```{r}
ggplot(data = temp_df) + 
  # geom_point(mapping = aes(x = NO, y = SOVOL), color = "red") +
  # geom_point(mapping = aes(x = NO, y = SOVOLtdcs), color = "green") +
  geom_point(mapping = aes(x = NO, y = SOVOLobpcs), color = "blue")
```

```{r}
# sm - val median by second

temp_sm_df <- temp_df %>% 
  group_by(TIMEm) %>% 
  summarise(SOVOLobpcs = median(SOVOLobpcs))
temp_sm_df
```


```{r}
ggplot(data = temp_sm_df) + 
  geom_point(mapping = aes(x = TIMEm, y = SOVOLobpcs), color = "blue")
```

```{r}
obp_atts_by_obp_df <- read_csv("resources/4_obp_atts_by_obp_df.csv")
obp_atts_by_obp_df
```

```{r}
obp_atts_by_obp_df %>% arrange(desc(MINMAXRATIO))
# obp_atts_by_obp_df %>% arrange(BUYSELLYIELD)
```


```{r}
pbegin <- obp_dynatts_no_price_df %>% 
  .$DATETIMEMLLS %>% 
  min(.)
print(pbegin)

pend <- obp_dynatts_no_price_df %>% 
  .$DATETIMEMLLS %>% 
  max(.) 
print(pend)

pcolor <- function(att, plotno) {
  color = ""
  if (plotno == plotno) {
    if (att == 'BOVOL') color = "green"
    else if (att == 'SOVOL') color = "red"
    else if (att == 'BTVOL' | att == 'STVOL') color = "blue"
    else color = "white"
  } else {
    if (att == 'BOVOL') color = "green"#"aquamarine"
    else if (att == 'SOVOL') color = "red"#"coral"
    else if (att == 'BTVOL' | att == 'STVOL') color = "blue" #"cadetblue1"
    else color = "white"
  }
  # print(paste(att, plotno, color))
  return(color)
}
td_df <- obp_dynatts_no_price_df %>% 
  filter((DATETIMEMLLS >= pbegin & DATETIMEMLLS <= pend) & (ATT == "BOVOL" | ATT == "SOVOL" | ATT == "BTVOL" | ATT == "STVOL") & PRICE > 2145.0 & PRICE < 2195.0) %>%
  mutate(pcolor = map2(ATT, OBPLOTNO, ~pcolor(.x, .y)) %>% unlist())
td_df
```

```{r}
curplotno = 302

pbegin <- obp_dynatts_no_price_df %>%
  filter(OBPLOTNO == curplotno) %>%
  .$DATETIMEMLLS %>%
  min(.)

pend <- obp_dynatts_no_price_df %>%
  filter(OBPLOTNO == curplotno) %>%
  .$DATETIMEMLLS %>%
  max(.)

pcolor <- function(att, plotno) {
  color = ""
  if (plotno == curplotno) {
    if (att == 'BOVOL') color = "green"
    else if (att == 'SOVOL') color = "red"
    else if (att == 'BTVOL' | att == 'STVOL') color = "blue"
    else color = "white"
  } else {
    if (att == 'BOVOL') color = "aquamarine"
    else if (att == 'SOVOL') color = "coral"
    else if (att == 'BTVOL' | att == 'STVOL') color = "cadetblue1"
    else color = "white"
  }
  # print(paste(att, plotno, color))
  return(color)
}

pshape <- function(att, plotno) {
  color = ""
  if (plotno == curplotno) {
    shape = 16
  } else {
    shape = 4
  }
  # print(paste(att, plotno, color))
  return(shape)
}

psize <- function(att, plotno) {
  color = ""
  if (plotno == curplotno) {
    size = 1.0
  } else {
    size = 0.5
  }
  # print(paste(att, plotno, color))
  return(size)
}

plot_df <- obp_dynatts_no_price_df %>% 
  filter((DATETIMEMLLS >= pbegin & DATETIMEMLLS <= pend) & (ATT == "BOVOL" | ATT == "SOVOL" | ATT == "BTVOL" | ATT == "STVOL") & PRICE > 2145.0 & PRICE < 2205.0) %>%
  mutate(pcolor = map2(ATT, OBPLOTNO, ~pcolor(.x, .y)) %>% unlist(),
         pshape = map2(ATT, OBPLOTNO, ~pshape(.x, .y)) %>% unlist(),
         psize = map2(ATT, OBPLOTNO, ~psize(.x, .y)) %>% unlist())
plot_df %>% filter(OBPLOTNO == curplotno)
```

```{r}
dt1 <- td_df %>% filter(ATT != "BTVOL" & ATT != "STVOL")
dt2 <- td_df %>% filter(ATT == "BTVOL" | ATT == "STVOL")
ggplot() + 
  geom_point(data = dt1, mapping = aes(x = TIME, y = PRICE), color = dt1$pcolor, shape = 4, size = 0.5) +
  geom_point(data = dt2, mapping = aes(x = TIME, y = PRICE), color = dt2$pcolor, shape = 4, size = 0.5)
```

```{r}
td_df %>% filter(ATT != "BTVOL" & ATT != "STVOL")
```


```{r}
dt11 <- plot_df %>% filter(OBPLOTNO != curplotno & ATT != "BTVOL" & ATT != "STVOL")
dt12 <- plot_df %>% filter(OBPLOTNO != curplotno & (ATT == "BTVOL" | ATT == "STVOL"))
dt21 <- plot_df %>% filter(OBPLOTNO == curplotno & ATT != "BTVOL" & ATT != "STVOL")
dt22 <- plot_df %>% filter(OBPLOTNO == curplotno & (ATT == "BTVOL" | ATT == "STVOL"))
ggplot() + 
  geom_point(data = dt11, mapping = aes(x = TIME, y = PRICE), 
             color = dt11$pcolor, shape = dt11$pshape, size = dt11$psize) + 
  geom_point(data = dt12, mapping = aes(x = TIME, y = PRICE), 
             color = dt12$pcolor, shape = dt12$pshape, size = dt12$psize) + 
  geom_point(data = dt21, mapping = aes(x = TIME, y = PRICE), 
             color = dt21$pcolor, shape = dt21$pshape, size = dt21$psize) + 
  geom_point(data = dt22, mapping = aes(x = TIME, y = PRICE), 
             color = dt22$pcolor, shape = dt22$pshape, size = dt22$psize)
```

